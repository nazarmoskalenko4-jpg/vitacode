{% extends "base.html" %}

{% block content %}
<style>
  .vc-page {
    max-width: 1100px;
    margin: 0 auto;
  }
  .vc-title { font-size: 32px; margin-bottom: 20px; }
  .vc-section-title { font-size: 22px; margin: 0 0 12px; }
  .vc-card {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .vc-profile-layout { display: flex; flex-wrap: wrap; gap: 24px; }
  .vc-profile-table th { color: #6c757d; text-align: left; padding-right: 15px; }
  .vc-profile-table td { font-weight: 500; }

  .vc-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 10px;
  }
  .vc-stat-box {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
  }
  .vc-stat-label { font-size: 13px; color: #6c757d; text-transform: uppercase; margin-bottom: 5px; }
  .vc-stat-value { font-size: 24px; font-weight: 700; color: #212529; }
  .vc-stat-sub { font-size: 13px; margin-top: 4px; }

  .text-success-custom { color: #198754; }
  .text-danger-custom { color: #dc3545; }
  .text-primary-custom { color: #0d6efd; }

  .vc-table-wrapper { width: 100%; overflow-x: auto; }
  .vc-plan-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .vc-plan-table th, .vc-plan-table td { border: 1px solid #e5e7eb; padding: 10px 12px; vertical-align: middle; }
  .vc-plan-table thead th { background: #f3f4f6; font-weight: 600; text-align: left; }
  .vc-plan-table tfoot th { background: #e5e7eb; font-weight: 700; }
  
  .day-header {
    color: #0d6efd;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }

  .dish-desc {
    font-size: 0.85em;
    color: #6c757d;
    margin-top: 4px;
    line-height: 1.3;
  }

  .vc-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 40px;
  }
</style>

<div class="vc-page">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="vc-title mb-0">
      {% if is_week %}–¢–∏–∂–Ω–µ–≤–∏–π{% else %}–î–µ–Ω–Ω–∏–π{% endif %} –ø–ª–∞–Ω —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è
    </h1>
    <a href="/ui/profiles" class="btn btn-outline-secondary btn-sm">–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
  </div>

  <section class="vc-card">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h2 class="vc-section-title">–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
            <div class="vc-profile-layout">
            <table class="vc-profile-table">
                <tbody>
                <tr><th>–¶—ñ–ª—å</th><td>{{ goal_label }}</td></tr>
                <tr><th>–°—Ç–∞—Ç—å / –í—ñ–∫</th><td>{{ profile.sex }} / {{ profile.age }} —Ä–æ–∫—ñ–≤</td></tr>
                <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏</th><td>{{ profile.height_cm }} —Å–º / {{ profile.weight_kg }} –∫–≥</td></tr>
                <tr><th>BMR / TDEE</th><td>{{ profile.bmr|round(0) }} / {{ profile.tdee|round(0) }}</td></tr>
                <tr><th>–¶—ñ–ª—å –∫–∫–∞–ª (–¥–µ–Ω—å)</th><td>{{ profile.target_kcal }} –∫–∫–∞–ª</td></tr>
                </tbody>
            </table>
            </div>
        </div>
        
        <div>
            <form method="post" action="/ui/profile/delete/{{ profile.id }}?origin=result" 
                  onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ñ—ñ–ª—å —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—É?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    üóë –í–∏–¥–∞–ª–∏—Ç–∏
                </button>
            </form>
        </div>
    </div>
  </section>

  <section class="vc-card">
    <h2 class="vc-section-title">
      –ê–Ω–∞–ª—ñ–∑ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ {% if is_week %}(–∑–∞ 7 –¥–Ω—ñ–≤){% endif %}
    </h2>
    
    {% set actual = stats.total_kcal %}
    {% set target = stats.target_kcal_period %}
    {% set budget = stats.budget_period %}
    {% set price = stats.total_price %}
    
    {% set percent = (actual / target * 100) | round(1) %}
    {% set budget_left = budget - price %}

    <div class="vc-stats-grid">
      <div class="vc-stat-box">
        <div class="vc-stat-label">–ö–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å</div>
        <div class="vc-stat-value {{ 'text-success-custom' if (percent > 90 and percent < 110) else 'text-primary-custom' }}">
          {{ actual }} <span style="font-size:14px; color:#6c757d;">/ {{ target }}</span>
        </div>
        <div class="vc-stat-sub">
            –í–∏–∫–æ–Ω–∞–Ω–Ω—è: <strong>{{ percent }}%</strong>
        </div>
      </div>

      <div class="vc-stat-box">
        <div class="vc-stat-label">–ë—é–¥–∂–µ—Ç</div>
        <div class="vc-stat-value {{ 'text-success-custom' if price <= budget else 'text-danger-custom' }}">
          {{ price|round(0) }} <span style="font-size:14px; color:#6c757d;">/ {{ budget }} –≥—Ä–Ω</span>
        </div>
        <div class="vc-stat-sub">
          {% if budget_left >= 0 %}
            –ó–∞–ª–∏—à–æ–∫: <strong>{{ "%.2f"|format(budget_left) }} –≥—Ä–Ω</strong>
          {% else %}
            –ü–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è: {{ "%.2f"|format(budget_left|abs) }} –≥—Ä–Ω
          {% endif %}
        </div>
      </div>

      <div class="vc-stat-box">
        <div class="vc-stat-label">–í—Å—å–æ–≥–æ —Å—Ç—Ä–∞–≤</div>
        <div class="vc-stat-value">{{ stats.items_count }}</div>
        <div class="vc-stat-sub">–ø–æ–∑–∏—Ü—ñ–π —É —Å–ø–∏—Å–∫—É</div>
      </div>
    </div>
  </section>

  {% for day_plan in plans_list %}
  <section class="vc-card">
    
    {% if is_week %}
      <h3 class="vc-section-title day-header">–î–µ–Ω—å {{ loop.index }}</h3>
    {% else %}
      <h2 class="vc-section-title">–î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫</h2>
    {% endif %}

    <div class="vc-table-wrapper">
      <table class="vc-plan-table">
        <colgroup>
            <col style="width: 10%;"> <col style="width: 35%;"> <col style="width: 10%;"> <col style="width: 10%;"> <col style="width: 25%;"> <col style="width: 10%;"> </colgroup>
        <thead>
          <tr>
            <th>–¢–∏–ø</th>
            <th>–ù–∞–∑–≤–∞ / –°–∫–ª–∞–¥</th>
            <th>–í–∞–≥–∞</th> <th>–ö–∫–∞–ª</th>
            <th>–ë / –ñ / –í</th>
            <th>–¶—ñ–Ω–∞</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(p=0, f=0, c=0) %}
          
          {% for item in day_plan["–µ–ª–µ–º–µ–Ω—Ç–∏"] %}
            <tr>
              <td>
                  {% if item["—Ç–∏–ø –ø—Ä–∏–π–æ–º—É"] == 'breakfast' %}–°–Ω—ñ–¥–∞–Ω–æ–∫
                  {% elif item["—Ç–∏–ø –ø—Ä–∏–π–æ–º—É"] == 'lunch' %}–û–±—ñ–¥
                  {% elif item["—Ç–∏–ø –ø—Ä–∏–π–æ–º—É"] == 'dinner' %}–í–µ—á–µ—Ä—è
                  {% elif item["—Ç–∏–ø –ø—Ä–∏–π–æ–º—É"] == 'snack' %}–ü–µ—Ä–µ–∫—É—Å
                  {% else %}{{ item["—Ç–∏–ø –ø—Ä–∏–π–æ–º—É"] }}{% endif %}
              </td>
              <td>
                  <div class="fw-bold">
                    {{ item["–Ω–∞–∑–≤–∞"] }}
                    {% if item.get("count", 1) > 1 %}
                        <span class="text-primary ms-1">(x{{ item["count"] }})</span>
                    {% endif %}
                  </div>
                  
                  {% if item.get("–æ–ø–∏—Å") %}
                    <div class="dish-desc">
                        {{ item["–æ–ø–∏—Å"] }}
                    </div>
                  {% endif %}
              </td>
              <td>
                  {% if item.get("–≤–∞–≥–∞ –≥") %}
                    {{ item["–≤–∞–≥–∞ –≥"]|int }} –≥
                  {% else %}
                    -
                  {% endif %}
              </td>
              <td>{{ item["–∫–∫–∞–ª"] }}</td>
              <td>
                  <span class="d-block text-nowrap">–ë: {{ item["–±—ñ–ª–∫–∏ –≥"] }}</span>
                  <span class="d-block text-nowrap">–ñ: {{ item["–∂–∏—Ä–∏ –≥"] }}</span>
                  <span class="d-block text-nowrap">–í: {{ item["–≤—É–≥–ª–µ–≤–æ–¥–∏ –≥"] }}</span>
              </td>
              <td class="fw-bold">{{ item["—Ü—ñ–Ω–∞ –≥—Ä–Ω"] }} ‚Ç¥</td>
            </tr>
            {% set ns.p = ns.p + item["–±—ñ–ª–∫–∏ –≥"] %}
            {% set ns.f = ns.f + item["–∂–∏—Ä–∏ –≥"] %}
            {% set ns.c = ns.c + item["–≤—É–≥–ª–µ–≤–æ–¥–∏ –≥"] %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3">–†–∞–∑–æ–º –∑–∞ –¥–µ–Ω—å</th> <th>{{ day_plan["–ø—ñ–¥—Å—É–º–æ–∫"]["–∫–∫–∞–ª"] }}</th>
            <th>
                –ë: {{ "%.1f"|format(ns.p) }} / 
                –ñ: {{ "%.1f"|format(ns.f) }} / 
                –í: {{ "%.1f"|format(ns.c) }}
            </th>
            <th>{{ day_plan["–ø—ñ–¥—Å—É–º–æ–∫"]["—Ü—ñ–Ω–∞ –≥—Ä–Ω"] }} ‚Ç¥</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>
  {% endfor %}

  <div class="vc-actions">
    <form method="post" action="/ui/download">
      <input type="hidden" name="plan_json" value='{{ plans_json }}'>
      <input type="hidden" name="is_week" value='{{ "true" if is_week else "false" }}'>
      <button type="submit" class="btn btn-outline-primary btn-lg">
        ‚¨á –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–µ–Ω—é
      </button>
    </form>

    <form method="get" action="/ui/plan">
      <button type="submit" class="btn btn-primary btn-lg">
        –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –ø–ª–∞–Ω
      </button>
    </form>
  </div>

</div>
{% endblock %}